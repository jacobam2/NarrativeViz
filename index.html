<!DOCTYPE html>
<html class="OVERALL">
  <!-- CSS styles for all items on page -->
  <style>
    /* Style for HTML section */
    .OVERALL {
      position: absolute;
      width: 100%;
      height: 100%;
      top: 0%;
      left: 0%;
      margin-top: 0;
      margin-left: 0;
      margin-right: 0;
      margin-bottom: 0;
      overflow-y: scroll;
    }
    /* Style for Body section */
    .Body {
      position: fixed;
      width: 100%;
      height: 100%;
      top: 0%;
      left: 0%;
      margin-top: 0;
      margin-left: 0;
      margin-right: 0;
      margin-bottom: 0;
    }
    /* Style for tiles in any section */
    .Title {
      text-align: center;
      position: relative;
      width: 100%;
      height: 10%;
      top: 0%;
      left: 0%;
      margin-top: 0;
      margin-left: 0;
      margin-right: 0;
      margin-bottom: 0;
    }
    /* Style for annotations */
    .AnnotationDiv {
      position: absolute;
      width: 100%;
      height: 90%;
      top: 10%;
      left: 0%;
      margin-top: 0;
      margin-left: 0;
      margin-right: 0;
      margin-bottom: 0;
    }
    /* Style for annotation SVG canvas */
    .AnnotationSVG {
      position: absolute;
      width: 100%;
      height: 100%;
      top: 0%;
      left: 0%;
      margin-top: 0%;
      margin-left: 0%;
      margin-right: 0%;
      margin-bottom: 0%;
    }
    /* Style for first pie chart (left) */
    .Pie1 {
      text-align: center;
      position: absolute;
      width: 50%;
      height: 40%;
      top: 10%;
      margin-top: 0;
      margin-left: 0;
      margin-right: 0;
      margin-bottom: 0;
    }
    /* Style for second pie chart (right) */
    .Pie2 {
      text-align: center;
      position: absolute;
      width: 50%;
      height: 40%;
      top: 10%;
      left: 50%;
      margin-top: 0;
      margin-left: 0;
      margin-right: 0;
      margin-bottom: 0;
    }
    /* Style for line chart (below pie charts) */
    .Line {
      text-align: center;
      position: absolute;
      width: 100%;
      height: 60%;
      top: 50%;
      margin-top: 0;
      margin-left: 0;
      margin-right: 0;
      margin-bottom: 0;
    }
    /* Style for pie chart SVG canvases */
    .PieSVG {
      position: absolute;
      width: 60%;
      height: 90%;
      top: 10%;
      left: 20%;
      margin-top: 0;
      margin-left: 0;
      margin-right: 0;
      margin-bottom: 0;
    }
    /* Style for line chart SVG canvas */
    .LineSVG {
      position: absolute;
      width: 95%;
      height: 72%;
      top: 10%;
      left: 2.5%;
      margin-top: 0%;
      margin-left: 0%;
      margin-right: 0%;
      margin-bottom: 0%;
    }
    /* Style for Annotation */
    .Annotation {
      font-weight: bold;
      opacity: 1
    }
    /* Style for tooltips */
    .Tooltip {
    }
  </style>

  <!-- Import D3 -->
  <script src='https://d3js.org/d3.v5.min.js'></script>
  
  <!-- Import D3 Annotation -->
  <script src='d3-annotation.js'></script>

  <!-- Header just has information about page -->
  <head>  
    <title>College Scholarship Breakdown 2010-2015</title>
    <meta charset="UTF-8">
    <meta name="description" content="This page contains a hypothetical breakdown of college scholarships for a class project for CS416.">
  </head>

  <!-- Body has meat of page -->
  <body class="Body" onload="init()">
    <h1 class="Title">College Scholarship Breakdown 2010-2015</h1>

    <!-- Annotation division -->
    <div class="AnnotationDiv">
      <svg class="AnnotationSVG">
      </svg>
    </div>

    <!-- Left pie chart division -->
    <div class="Pie1">
      <h2 class="Title">Scholarship Allocation by College</h2>
      <svg class="PieSVG">
      </svg>
    </div>
    
    <!-- Right pie chart division -->
    <div class="Pie2">
      <h2 class ="Title">Scholarship Allocation by Major</h2>
      <svg class="PieSVG">
      </svg>
    </div>

    <!-- Line chart division -->
    <div class="Line">
      <h2 class="Title">Scholarship Amount Over Time</h2>
      <svg class="LineSVG">
      </svg>
    </div>


    <!-- Body scripts -->
    <script>
      // Parameters
      var selectedCollege;
      var selectedMajor;
      var previousSelectedCollegeElement;
      var previousSelectedMajorElement;
      var sceneNumber;
      
      // Global variables holding views of database
      var collegeNames;
      var collegePercentages;
      var majorNames;
      var majorPercentages;
      var amountData;
      var scholarshipDatabase;

      // Global variable relating to screen dimensions
      var bodyWidth;
      var bodyHeight;

      // Global variables relating to pie chart sizing
      var pieRadius;
      var pieCenterX;
      var pieCenterY;

      // Global variables relating to line chart sizing
      var lineOffsetX;
      var lineOffsetY;
      var lineWidth;
      var lineHeight;
      
      // Computes body dimensions, excluding title
      function computeBodyDimensions()
      {
        var bodyBBox = d3.select('div[class=AnnotationDiv]').node().getBoundingClientRect();
        bodyWidth = bodyBBox.width;
        bodyHeight = bodyBBox.height;
      }

      // Computes pie chart dimensions
      function computePieDimensions()
      {
        var scaleFactor = 0.8
        var samplePieBBox = d3.select('div[class=Pie1]').select('svg').node().getBoundingClientRect();
        if(samplePieBBox.height < samplePieBBox.width)
          pieRadius = scaleFactor * (samplePieBBox.height / 2);
        else
          pieRadius = scaleFactor * (samplePieBBox.width / 2);
        pieCenterX = samplePieBBox.width/2;
        pieCenterY = samplePieBBox.height/2;
      }
      
      // Computes line chart dimensions / metadata
      function computeLineDimensions()
      {
        var xOffsetFactor = 0.04;
        var yBeginOffsetFactor = 0.025;
        var yEndOffsetFactor = 0.05;
        var lineBBox = d3.select('div[class=Line]').select('svg').node().getBoundingClientRect();
        lineOffsetX = xOffsetFactor * lineBBox.width;
        lineWidth = lineBBox.width - 2 * lineOffsetX;
        var lineOffsetYEnd = yEndOffsetFactor * lineBBox.height;
        lineOffsetY = yBeginOffsetFactor * lineBBox.height;
        lineHeight = lineBBox.height - lineOffsetY - lineOffsetYEnd;
      }

      // Computes the college data dictionary
      function computeCollegeData()
      {
        collegeDataDict = {};
        for(let i = 0; i < scholarshipDatabase.length; ++i)
        {
          var collegeName = scholarshipDatabase[i]['College'];
          if(!(collegeName in collegeDataDict))
          {
            collegeDataDict[collegeName] = Number(0)
          }
          collegeDataDict[collegeName] += Number(scholarshipDatabase[i]['Gift Amount'])
        }
        
        // Convert dictionary into arrays
        collegeNames = []
        collegePercentages = []
        var total = 0
        for(let key in collegeDataDict)
        {
          collegeNames.push(key);
          collegePercentages.push(collegeDataDict[key]);
          total += collegeDataDict[key];
        }
        for(let i = 0; i < collegePercentages.length; ++i)
          collegePercentages[i] /= total;
      }
      
      // Computes the major data given a college selection
      function computeMajorData()
      {
        if(selectedCollege === null)
        {
          majorNames=[null]
          majorPercentages=[1]
        }
        else
        {
          majorDataDict = {};
          for(let i = 0; i < scholarshipDatabase.length; ++i)
          {
            var collegeName = scholarshipDatabase[i]['College'];
            if(collegeName == selectedCollege)
            {
              var majorName = scholarshipDatabase[i]['Major'];
              if(!(majorName in majorDataDict))
              {
                majorDataDict[majorName] = Number(0)
              }
              majorDataDict[majorName] += Number(scholarshipDatabase[i]['Gift Amount'])
            }
          }
          
          // Convert dictionary into arrays
          majorNames = []
          majorPercentages = []
          var total = 0
          for(let key in majorDataDict)
          {
            majorNames.push(key)
            majorPercentages.push(majorDataDict[key])
            total += majorDataDict[key];
          }
          for(let i = 0; i < majorPercentages.length; ++i)
            majorPercentages[i] /= total;
        }
      }

      // Computes the amount data given a college selection and a major selection
      function computeAmountData()
      {
        if(selectedMajor === null)
        {
          amountData = []
          amountData.push(null)
        }
        else
        {
          amountDataDict = {};
          for(let i = 0; i < scholarshipDatabase.length; ++i)
          {
            var collegeName = scholarshipDatabase[i]['College'];
            var majorName = scholarshipDatabase[i]['Major'];
            if(collegeName == selectedCollege && majorName == selectedMajor)
            {
              var giftDate = scholarshipDatabase[i]['Gift Date'];
              if(!(giftDate in amountDataDict))
              {
                amountDataDict[giftDate] = 0
              }
              amountDataDict[giftDate] += Number(scholarshipDatabase[i]['Gift Amount']);
            }
          }
          // Flatten and sort amount data dictionary
          amountData = []
          for(let key in amountDataDict)
          {
            var obj = {};
            obj['Gift Date'] = key;
            obj['Gift Amount'] = amountDataDict[key];
            amountData.push(obj)
          }
          amountData.sort(function(a,b){ return Date.parse(a['Gift Date']) - Date.parse(b['Gift Date']); });
        }
      }

      // Initializes the college pie chart (left)
      function initializeCollegeChart()
      {
        var transform = 'translate('+pieCenterX+', '+pieCenterY+')';
        var pie = d3.pie();
        var arc = d3.arc().innerRadius(0).outerRadius(pieRadius);
        var colors = d3.scaleOrdinal().range(d3.schemeSet3);
        
        // Cleanup any old elements
        previousSelectedCollegeElement = null
        d3.select('div[class=Pie1]').select('svg').selectAll('g').remove();
        
        d3.select('div[class=Pie1]').select('svg')
          .append('g')
            .attr('transform',transform)
          .selectAll('path')
            .data(pie(collegePercentages))
            .enter()
            .append('path')
              .attr('d',arc)
              .attr('fill',function(d,i){return colors(i);})
              .attr('stroke',function(d,i){ if(selectedCollege == collegeNames[i]) { previousSelectedCollegeElement = d3.select(this); return 'black';} else {return colors(i);}})
              .attr('stroke-width',function(d,i){ if(selectedCollege == collegeNames[i]) {return 2;} else {return 1;}})
              .on("click",function(d,i)
                {
                  // Don't change selection if it is the same
                  if(selectedCollege == collegeNames[i] || sceneNumber < 5)
                    return
                    
                  // Change border around this element
                  d3.select(this).attr('stroke','black')
                                 .attr('stroke-width',2);
                  if(!(previousSelectedCollegeElement == null))
                  {
                    previousSelectedCollegeElement.attr('stroke',previousSelectedCollegeElement.attr('fill'))
                                                  .attr('stroke-width',1);
                  }
                  previousSelectedCollegeElement = d3.select(this);

                  // Update charts to reflect that this college has been selected
                  selectedCollege = collegeNames[i];
                  computeMajorData()
                  selectedMajor = null;
                  initializeMajorChart();
                  computeAmountData()
                  initializeAmountChart();
                })
              .on("mouseover",function(d,i)
                {
                  if(sceneNumber >= 5)
                  {
                    // Highlight slice
                    d3.select(this).attr('fill-opacity',0.2);
                    
                    // Compute tooltip metadata
                    var h1BB = d3.select('h1').node().getBoundingClientRect();
                    var Pie1BB = d3.select('div[class=Pie1]').select('g').node().getBoundingClientRect();
                    var selectedBB = d3.select(this).node().getBoundingClientRect();
                    var annotationX = selectedBB.x + selectedBB.width/2;
                    var annotationY = selectedBB.y - h1BB.height + selectedBB.height/2;
                    var noteSize = (h1BB.width-2*Pie1BB.width)/2;
                    var notePad = 0.025 * noteSize;
                    var annotationDx;
                    var annotationDy;
                    
                    // Set tooltip side based on slice center
                    if(annotationX < Pie1BB.x + Pie1BB.width/2)
                    {
                      annotationDx = Pie1BB.x-annotationX-(noteSize-2*notePad)/32-notePad;
                    }
                    else
                    {
                      annotationDx = Pie1BB.x+Pie1BB.width-annotationX+notePad+(noteSize-2*notePad)/32;
                    }
                    if(annotationY < Pie1BB.y + Pie1BB.height/2)
                    {
                      annotationDy = Pie1BB.y-annotationY;
                    }
                    else
                    {
                      annotationDy = Pie1BB.y+Pie1BB.width-annotationY;
                    }
                    const annotations = [
                      {
                        note: 
                        { 
                          label: collegeNames[i] + ": " + Number(100*collegePercentages[i]).toFixed(2) + '%',
                          wrap: (noteSize-2*notePad)/3
                        },
                        x: annotationX,
                        y: annotationY,
                        dx: annotationDx,
                        dy: annotationDy
                      },
                    ];
                    
                    // Register tooltip
                    d3.select('div[class=AnnotationDiv]').select("svg")
                      .append('g')
                        .attr('class','Annotation').call(d3.annotation().annotations(annotations))
                        .select('rect')
                          .style('fill-opacity',1)
                          .style('stroke','black');
                  }
                })
              .on("mouseout",function(d,i)
                {
                  if(sceneNumber >= 5)
                  {
                    // Remove highlight
                    d3.select(this).attr('fill-opacity',1);
                    
                    // Remove tooltip
                    d3.select('div[class=AnnotationDiv]').select("svg").selectAll('g').remove();
                  }
                });
      }
      
      // Initializes the major pie chart (right)
      function initializeMajorChart()
      {
        var defaultTitle = "Scholarship Allocation by Major";
        var transform = 'translate('+pieCenterX+', '+pieCenterY+')';
        var pie = d3.pie();
        var arc = d3.arc().innerRadius(0).outerRadius(pieRadius);
        var colors = d3.scaleOrdinal().range(d3.schemeSet3);
        
        // Reset chart title
        var chartTitle = defaultTitle;
        if(!(selectedCollege === null))
          chartTitle = selectedCollege + " " + chartTitle;
        d3.select('div[class=Pie2]').select('h2').text(chartTitle);

        // Cleanup any old elements
        previousSelectedMajorElement = null
        d3.select('div[class=Pie2]').select('svg').selectAll('*').remove();

        if(majorPercentages.length > 1)
        {
          d3.select('div[class=Pie2]').select('svg')
            .append('g')
              .attr('transform',transform)
            .selectAll('path')
              .data(pie(majorPercentages))
              .enter()
              .append('path')
                .attr('d',arc)
                .attr('fill',function(d,i){return colors(i);})
                .attr('stroke',function(d,i){ if(selectedMajor == majorNames[i]) { previousSelectedMajorElement = d3.select(this); return 'black'; } else {return colors(i);} })
                .attr('stroke-width',function(d,i){ if(selectedMajor == majorNames[i]) { return 2; } else {return 1;} })
                .on("click",function(d,i)
                {
                  // Don't change selection if it is the same or not on scene where selection possible
                  if(selectedMajor == majorNames[i] || sceneNumber < 5)
                    return
                
                  d3.select(this)
                    .attr('stroke','black')
                    .attr('stroke-width',2);
                  if(!(previousSelectedMajorElement == null))
                    previousSelectedMajorElement.attr('stroke',previousSelectedMajorElement.attr('fill'))
                                                .attr('stroke-width',1);
                  previousSelectedMajorElement = d3.select(this);

                  // Update charts to reflect that this major has been selected
                  selectedMajor = majorNames[i];
                  computeAmountData()
                  initializeAmountChart();
                })
                .on("mouseover",function(d,i)
                  {
                    if(sceneNumber >= 5)
                    {
                      d3.select(this).attr('fill-opacity',0.2);
                                          
                      // Compute tooltip metadata
                      var h1BB = d3.select('h1').node().getBoundingClientRect();
                      var Pie2BB = d3.select('div[class=Pie2]').select('g').node().getBoundingClientRect();
                      var selectedBB = d3.select(this).node().getBoundingClientRect();
                      var annotationX = selectedBB.x + selectedBB.width/2;
                      var annotationY = selectedBB.y - h1BB.height + selectedBB.height/2;
                      var noteSize = (h1BB.width-2*Pie2BB.width)/2;
                      var notePad = 0.025 * noteSize;
                      var annotationDx;
                      var annotationDy;
                      
                      // Set tooltip side based on slice center
                      if(annotationX < Pie2BB.x + Pie2BB.width/2)
                      {
                        annotationDx = Pie2BB.x - annotationX - notePad - (noteSize-2*notePad)/32;
                      }
                      else
                      {
                        annotationDx = Pie2BB.width/2 - selectedBB.width/2+notePad+(noteSize-2*notePad)/32;
                      }
                      if(annotationY < Pie2BB.y + Pie2BB.height/2)
                      {
                        annotationDy = Pie2BB.y - annotationY;
                      }
                      else
                      {
                        annotationDy = Pie2BB.height/2 - selectedBB.height/2;
                      }
                      const annotations = [
                        {
                          note: 
                          {
                            label: majorNames[i] + ": " + Number(100*majorPercentages[i]).toFixed(2) + '%',
                            wrap: (noteSize-2*notePad)/3
                          },
                          x: annotationX,
                          y: annotationY,
                          dx: annotationDx,
                          dy: annotationDy
                        },
                      ];
                      
                      // Register tooltip
                      d3.select('div[class=AnnotationDiv]').select("svg")
                        .append('g')
                          .attr('class','Annotation').call(d3.annotation().annotations(annotations))
                          .select('rect')
                            .style('fill-opacity',1)
                            .style('stroke','black');
                    }
                  })
                .on("mouseout",function()
                  {
                    if(sceneNumber >= 5)
                    {
                      d3.select(this).attr('fill-opacity',1);
                    
                      // Remove tooltip
                      d3.select('div[class=AnnotationDiv]').select("svg").selectAll('g').remove();
                    }
                  });
        }
        else if(selectedCollege != null)
        {
          d3.select('div[class=Pie2]').select('svg')
            .append('g')
              .attr('transform',transform)
            .selectAll('circle')
              .data(pie(majorPercentages))
              .enter()
              .append('circle')
                .attr('r',pieRadius)
                .attr('fill',function(d,i){return colors(i);})
                .attr('stroke',function(d,i){ if(selectedMajor == majorNames[i]) { previousSelectedMajorElement = d3.select(this); return 'black'; } else {return colors(i);} })
                .attr('stroke-width',function(d,i){ if(selectedMajor == majorNames[i]) { return 2; } else {return 1;} })
                .on("click",function(d,i)
                {
                  // Don't change selection if it is the same or not on scene where selection possible
                  if(selectedMajor == majorNames[i] || sceneNumber < 5)
                    return
                
                  d3.select(this)
                    .attr('stroke','black')
                    .attr('stroke-width',2);
                  if(!(previousSelectedMajorElement == null))
                    previousSelectedMajorElement.attr('stroke',previousSelectedMajorElement.attr('fill'))
                                                .attr('stroke-width',1);
                  previousSelectedMajorElement = d3.select(this);

                  // Update charts to reflect that this major has been selected
                  selectedMajor = majorNames[i];
                  computeAmountData()
                  initializeAmountChart();
                })
                .on("mouseover",function(d,i)
                  {
                    if(sceneNumber >= 5)
                    {
                      d3.select(this).attr('fill-opacity',0.2);
                                          
                      // Compute tooltip metadata
                      var h1BB = d3.select('h1').node().getBoundingClientRect();
                      var Pie2BB = d3.select('div[class=Pie2]').select('g').node().getBoundingClientRect();
                      var selectedBB = d3.select(this).node().getBoundingClientRect();
                      var annotationX = selectedBB.x + selectedBB.width/2;
                      var annotationY = selectedBB.y - h1BB.height + selectedBB.height/2;
                      var noteSize = (h1BB.width-2*Pie2BB.width)/2;
                      var notePad = 0.025 * noteSize;
                      var annotationDx;
                      var annotationDy;
                      
                      // Set tooltip side based on slice center
                      if(annotationX < Pie2BB.x + Pie2BB.width/2)
                      {
                        annotationDx = Pie2BB.x - annotationX - notePad - (noteSize-2*notePad)/32;
                      }
                      else
                      {
                        annotationDx = Pie2BB.width/2 - selectedBB.width/2+notePad+(noteSize-2*notePad)/32;
                      }
                      if(annotationY < Pie2BB.y + Pie2BB.height/2)
                      {
                        annotationDy = Pie2BB.y - annotationY;
                      }
                      else
                      {
                        annotationDy = Pie2BB.height/2 - selectedBB.height/2;
                      }
                      const annotations = [
                        {
                          note: 
                          {
                            label: majorNames[i] + ": " + Number(100*majorPercentages[i]).toFixed(2) + '%',
                            wrap: (noteSize-2*notePad)/3
                          },
                          x: annotationX,
                          y: annotationY,
                          dx: annotationDx,
                          dy: annotationDy
                        },
                      ];
                      
                      // Register tooltip
                      d3.select('div[class=AnnotationDiv]').select("svg")
                        .append('g')
                          .attr('class','Annotation').call(d3.annotation().annotations(annotations))
                          .select('rect')
                            .style('fill-opacity',1)
                            .style('stroke','black');
                    }
                  })
                .on("mouseout",function()
                  {
                    if(sceneNumber >= 5)
                    {
                      d3.select(this).attr('fill-opacity',1);
                    
                      // Remove tooltip
                      d3.select('div[class=AnnotationDiv]').select("svg").selectAll('g').remove();
                    }
                  });
        }
        else
        {
          d3.select('div[class=Pie2]').select('svg')
              .append('g')
                .attr('transform',transform)
              .selectAll('circle')
                .data(majorPercentages)
                .enter()
                .append('circle')
                  .attr('r',pieRadius)
                  .attr('fill',function(d,i){return colors(i);});
        }
      }
      
      // Initializes the amount line chart (bottom)
      function initializeAmountChart()
      {
        var defaultTitle = "Cumulative Daily Scholarship Amount Over Time";
        var colors = d3.scaleOrdinal().range(d3.schemeSet3);
        
        // Reset chart title
        var chartTitle = defaultTitle;
        if(!(selectedMajor === null))
          chartTitle = selectedMajor + " " + chartTitle;
        d3.select('div[class=Line]').select('h2').text(chartTitle);
        
        // Cleanup any old elements
        d3.select('div[class=Line]').select('svg').selectAll('*').remove();
        
        // Compute X axis scale
        var minDate = Date.parse("2010-01-02");
        var maxDate = Date.parse("2015-12-31");
        var xRange = [];
        var currentDate = minDate;
        var dateMonthInterval = 6
        while(currentDate < maxDate)
        {
          xRange.push(currentDate);
          var currentDateAsDate = new Date(currentDate)
          currentDateAsDate.setMonth(currentDateAsDate.getMonth()+dateMonthInterval)
          currentDate = currentDateAsDate.getTime();
        }
        xRange.push(maxDate)
        dateRange = [minDate,maxDate]
        var xaxis = d3.scaleTime()
              .domain(dateRange)
              .range([0,lineWidth]);
        
        // Compute X axis
        var xTranslation = 'translate('+lineOffsetX+', '+(lineHeight+lineOffsetY)+')';
        d3.select('div[class=Line]').select('svg')
          .append('g')
            .attr('transform',xTranslation)
          .call(d3.axisBottom(xaxis)
                        .tickValues(xRange)
                        .tickFormat(d3.timeFormat('%b %Y')));

        // Compute Y axis scale
        var maxScholarship = 500000
        var yRange = [1,10,100,1000,10000,100000,500000];
        var yaxis = d3.scaleLog()
                      .domain([1,maxScholarship])
                      .range([lineHeight,0]);
        
        // Compute Y axis
        var yTranslation = 'translate('+lineOffsetX+', '+lineOffsetY+')';
        d3.select('div[class=Line]').select('svg')
          .append('g')
            .attr('transform',yTranslation)
          .call(d3.axisLeft(yaxis)
                        .tickValues(yRange)
                        .tickFormat(d3.format('$~s')));
                        
        // If data selected, display line chart
        if(!(selectedMajor === null))
        {
          // Group containing points
          d3.select('div[class=Line]').select('svg')
            .append('g')
              .attr('transform',yTranslation)
            .selectAll('circle')
              .data(amountData)
              .enter().append('circle')
              .attr('cx',function(d,i){ return xaxis(Date.parse(d['Gift Date'])); })
              .attr('cy',function(d,i){ return yaxis(d['Gift Amount']); })
              .attr('r',function(d,i){ return 4; })
              .attr('fill','green')
              .on("mouseover",function(d,i)
                {
                  if(sceneNumber >= 5)
                  {
                    d3.select(this).attr('r',6);

                    // Compute tooltip metadata
                    var h1BB = d3.select('h1').node().getBoundingClientRect();
                    var LineBB = d3.select('div[class=Line]').select('g').node().getBoundingClientRect();
                    var selectedBB = d3.select(this).node().getBoundingClientRect();
                    var annotationX = selectedBB.x + selectedBB.width/2;
                    var annotationY = selectedBB.y - h1BB.height + selectedBB.height/2;
                    var noteSize = 0.025 * h1BB.width;
                    var notePad = 0.025 * noteSize;
                    var annotationDx;
                    var annotationDy;
                    
                    // Set tooltip side based on slice center
                    if(annotationX < LineBB.width/2)
                    {
                      annotationDx = selectedBB.width/2 + notePad;
                    }
                    else
                    {
                      annotationDx = -(selectedBB.width/2 + notePad);
                    }
                    if(annotationY < LineBB.height/2)
                    {
                      annotationDy = LineBB.y - annotationY;
                    }
                    else
                    {
                      annotationDy = LineBB.height/2 - selectedBB.height/2;
                    }
                    const annotations = [
                      {
                        note: 
                        {
                          label:  ""+amountData[i]['Gift Date'] +": " + Number(amountData[i]['Gift Amount']).toLocaleString("en-US", {style: 'currency', currency: 'USD'}),
                          wrap: (noteSize-2*notePad)/3
                        },
                        x: annotationX,
                        y: annotationY,
                        dx: annotationDx,
                        dy: annotationDy
                      },
                    ];
                    
                    // Register tooltip
                    d3.select('div[class=AnnotationDiv]').select("svg")
                      .append('g')
                        .attr('class','Annotation').call(d3.annotation().annotations(annotations))
                        .select('rect')
                          .style('fill-opacity',1)
                          .style('stroke','black');
                  }
                })
              .on("mouseout",function()
                {
                  if(sceneNumber >= 5)
                  {
                    d3.select(this).attr('r',4);

                    // Remove tooltip
                    d3.select('div[class=AnnotationDiv]').select("svg").selectAll('g').remove();
                  }
                });
              
          // Group containing lines (requires more than one data item)
          if(amountData.length > 1)
          {
            lineData = amountData.slice(0,-1);
            d3.select('div[class=Line]').select('svg')
              .append('g')
                .attr('transform',yTranslation)
              .selectAll('line')
                .data(lineData)
                .enter().append('line')
                .attr('x1',function(d,i){ return xaxis(Date.parse(d['Gift Date'])); })
                .attr('y1',function(d,i){ return yaxis(d['Gift Amount']); })
                .attr('x2',function(d,i){ return xaxis(Date.parse(amountData[i+1]['Gift Date'])); })
                .attr('y2',function(d,i){ return yaxis(amountData[i+1]['Gift Amount']); })
                .attr('stroke','blue');
          }
        }
        else
        {
          // Display no data selected
        }
      }
      
      // Transitions to scene 1
      function transitionScene1()
      {
        sceneNumber=1;
      
        // Grey out background
        d3.selectAll('div').style('opacity',0.4);
        
        // Bring annotation div to front
        d3.select('div[class=AnnotationDiv]').raise().style('opacity',1);
        
        // Add initial welcome message
        var initialText = [
                   "Scholarship funding is an indicator of career opportunities available for a particular major.",
                   "The following will demonstrate how to use this dashboard to analyze scholarship funding.     ",
                   "This information may provide helpful insight when deciding on your major.                    ", 
                   "Click \"begin\" to start the tutorial.                                                                     ",
                   "If you are on Windows, make sure to hide your task bar to see all plots.                        "];
        var titleText = "Welcome to the College Scholarship Breakdown!";

        // Construct initial welcome screen
        var welcomeWidth = bodyWidth * 0.6;
        var welcomeHeight = bodyHeight * 0.6;
        var welcomeX = (bodyWidth - welcomeWidth)/2;
        var welcomeY = (bodyHeight - welcomeHeight)/2;
        var textXOffset = 0.025 * welcomeWidth;
        var textYOffset = 0.05 * welcomeHeight;
        var titleLength = 0.8 * welcomeWidth;
        var titleHeight = 0.1 * welcomeHeight;
        var titleX = welcomeX+(welcomeWidth - titleLength)/2;
        var titleY = welcomeY+textYOffset+titleHeight;
        var textLength = 0.95 * welcomeWidth;
        var totalTextHeight = (welcomeHeight-titleHeight-5*textYOffset);
        var textDy = (0.6*welcomeHeight-2*textYOffset)/initialText.length;
        var textX = welcomeX+textXOffset;
        var textY = titleY+2*textYOffset;
        var buttonWidth = welcomeWidth * 0.15;
        var buttonHeight = welcomeHeight * 0.15;
        var buttonXOffset = 0.025 * welcomeWidth;
        var buttonYOffset = 0.025 * welcomeHeight;
        var buttonX = welcomeX + welcomeWidth - buttonXOffset - buttonWidth;
        var buttonY = welcomeY + welcomeHeight - buttonYOffset - buttonHeight;
        var buttonTextXOffset = 0.025 * buttonWidth;
        var buttonTextYOffset = 0.025 * buttonHeight;
        var buttonTextLength = buttonWidth - 2 * buttonTextXOffset;
        var buttonTextSize = 0.8*(buttonHeight - 2 * buttonTextYOffset);
        d3.select('div[class=AnnotationDiv]').select("svg")
          .append("g")
          .append('rect')
            .attr('x',welcomeX)
            .attr('y',welcomeY)
            .attr('width',welcomeWidth)
            .attr('height',welcomeHeight)
            .attr('fill','white')
            .style('stroke','black');
        d3.select('div[class=AnnotationDiv]').select("svg")
          .append("g")
          .append("text")
            .attr('x',titleX)
            .attr('y',titleY)
            .attr('textLength',titleLength)
            .attr('lengthAdjust','spacingAndGlyphs')
            .text(titleText)
            .style('font-weight','bold')
            .style('font-size',titleHeight);
        d3.select('div[class=AnnotationDiv]').select("svg")
          .append("g")
          .selectAll('text')
            .data(initialText)
            .enter().append('text')
              .attr('x',textX)
              .attr('y',textY)
              .attr('dy',function(d,i){ return i * textDy; })
              .attr('textLength',textLength)
              .attr('lengthAdjust','spacing')
              .text(function(d){ return d; })
              .attr('xml:space','preserve')
              .style('font-size',Math.floor(0.5*titleHeight));
        d3.select('div[class=AnnotationDiv]').select("svg")
          .append("g")
            .append('rect')
              .attr('x',buttonX)
              .attr('y',buttonY)
              .attr('width',buttonWidth)
              .attr('height',buttonHeight)
              .attr('fill','grey')
              .style('stroke','black')
              .on('click',transitionScene2);
        d3.select('div[class=AnnotationDiv]').select("svg")
          .append("g")
            .append('text')
              .attr('x',buttonX+buttonTextXOffset)
              .attr('y',buttonY+buttonTextYOffset+buttonTextSize)
              .attr('textLength',buttonTextLength)
              .attr('lengthAdjust','spacingAndGlyphs')
              .text('Begin')
              .style('font-size',buttonTextSize)
              .on('click',transitionScene2);
      }
      
      // Transitions to scene 2
      function transitionScene2()
      {
        sceneNumber=2;
        
        // Create annotation to explain scene
        d3.select('div[class=AnnotationDiv]').selectAll('g').remove();
        d3.select('div[class=Pie1]').style('opacity',1);
        selectedCollege = collegeNames[0];
        computeMajorData();
        initializeCollegeChart();
        initializeMajorChart();
        var h1BB = d3.select('h1').node().getBoundingClientRect();
        var Pie1BB = d3.select('div[class=Pie1]').select('g').node().getBoundingClientRect();
        var selectedBB = previousSelectedCollegeElement.node().getBoundingClientRect();
        var noteSize = (h1BB.width-2*Pie1BB.width)/2;
        var notePad = 0.025 * noteSize;
        var annotationX = selectedBB.x + selectedBB.width/2;
        var annotationY = selectedBB.y - h1BB.height + selectedBB.height/2;
        var annotationDx = Pie1BB.width/2+selectedBB.width/2+notePad;
        var annotationDy = 0
        const annotations = [
          {
            note: 
            { 
              label: "First, select a college of interest. " +
                     "Hovering over a slice will display the college and relative percentage of total scholarship for that college. " +
                     "Clicking a slice will select it, displaying the college name and corresponding major data in the chart to the right. " +
                     "Here, we select the College of Music. " +
                     "Click here to continue.",
              wrap: noteSize-2*notePad
            },
            x: annotationX,
            y: annotationY,
            dx: annotationDx,
            dy: annotationDy
          },
        ];
        d3.select('div[class=AnnotationDiv]').select("svg")
          .append('g')
            .attr('class','Annotation')
            .call(d3.annotation().annotations(annotations))
              .on('click',transitionScene3)
              .select('rect')
                .style('fill-opacity',1)
                .style('stroke','black');
      }
      
      // Transitions to scene 3
      function transitionScene3()
      {
        sceneNumber=3;
        d3.select('div[class=AnnotationDiv]').selectAll('g').remove();
        d3.select('div[class=Pie1]').style('opacity',0.6);
        d3.select('div[class=Pie2]').style('opacity',1);
        selectedMajor = majorNames[0];
        computeMajorData();
        computeAmountData();
        initializeMajorChart();
        initializeAmountChart();
        var h1BB = d3.select('h1').node().getBoundingClientRect();
        var Pie2BB = d3.select('div[class=Pie2]').select('g').node().getBoundingClientRect();
        var selectedBB = previousSelectedMajorElement.node().getBoundingClientRect();
        var noteSize = (h1BB.width-2*Pie2BB.width)/2;
        var notePad = 0.025 * noteSize;
        var annotationX = selectedBB.x + selectedBB.width/2;
        var annotationY = selectedBB.y - h1BB.height + selectedBB.height/2;
        var annotationDx = -(Pie2BB.width/2-selectedBB.width/2)-notePad;
        var annotationDy = 0
        const annotations = [
          {
            note: 
            { 
              label: "Next, select a major of interest. " +
                     "Hovering over a slice will display the major and relative percentage of total scholarships for that major for the given college. " +
                     "Clicking a slice will select it, displaying the major name and corresponding major data in the chart below. " +
                     "Here, we select Music major. " +
                     "Click here to continue.",
              wrap: noteSize-2*notePad
            },
            x: annotationX,
            y: annotationY,
            dx: annotationDx,
            dy: annotationDy
          },
        ];
        d3.select('div[class=AnnotationDiv]').select("svg")
          .append('g')
            .attr('class','Annotation')
            .call(d3.annotation().annotations(annotations))
              .on('click',transitionScene4)
              .select('rect')
                .style('fill-opacity',1)
                .style('stroke','black');
      }
      
      // Transitions to scene 4
      function transitionScene4()
      {
        sceneNumber=4;
        d3.select('div[class=AnnotationDiv]').selectAll('g').remove();
        d3.select('div[class=Pie2]').style('opacity',0.6);
        d3.select('div[class=Line]').style('opacity',1);
        
        // Select a random datapoint in the middle for demonstration
        var selectedDatapoint;
        d3.select('div[class=Line]').selectAll('circle')
          .attr('r',function(d,i){ if(i == Math.round(amountData.length / 2)){ selectedDatapoint = d3.select(this); return 6} else{return 4}});

        var h1BB = d3.select('h1').node().getBoundingClientRect();
        var Pie1BB = d3.select('div[class=Pie1]').select('g').node().getBoundingClientRect();
        var selectedBB = selectedDatapoint.node().getBoundingClientRect();
        var noteSize = (h1BB.width-2*Pie1BB.width)/2;
        var notePad = 0.025 * noteSize;
        var annotationX = selectedBB.x + selectedBB.width/2;
        var annotationY = selectedBB.y - h1BB.height + selectedBB.height/2;
        var annotationDx = Pie1BB.width/2+selectedBB.width/2+notePad;
        var annotationDy = 0
        const annotations = [
          {
            note: 
            { 
              label: "Finally, daily scholarship amounts will be displayed for the college and major you selected. " +
                     "Hovering over a data point will display the daily total scholarship amount in dollars. " +
                     "We can see that the amount of scholarship money allocated to music has increased over time, but is currently on a downtrend. " +
                     "We can conclude that there are more opportunities for music majors than in the past, though current demand may be decreasing." +
                     "Click here to end tutorial.",
              wrap: noteSize-2*notePad
            },
            className: "show-bg",
            x: annotationX,
            y: annotationY,
            dx: annotationDx,
            dy: annotationDy
          },
        ];
        d3.select('div[class=AnnotationDiv]').select("svg")
          .append('g')
            .attr('class','Annotation')
            .call(d3.annotation().annotations(annotations))
              .on('click',transitionScene5)
              .raise()
              .select('rect')
                .style('fill-opacity',1)
                .style('stroke','black');
      }
      
      // Transitions to scene 5
      function transitionScene5()
      {
        sceneNumber=5;
        d3.select('div[class=Line]').selectAll('circle')
          .attr('r',4);
        
        // Fully un-greyout background
        d3.selectAll('div').style('opacity',1);
        
        // Remove everything in annotation div and send to back
        d3.select('div[class=AnnotationDiv]').lower().select('svg').selectAll('g').remove();
      }

      // Loads the database and initializes the web page to scene 1 
      async function init() {
        // Load scholarship database.
        scholarshipDatabase  = await d3.csv('scholarships.csv');

        // Initialize scene number
        sceneNumber = 0;

        // Compute body dimensions
        computeBodyDimensions();

        // Compute Pie chart dimensions
        computePieDimensions();
        
        // Compute line chart dimensions
        computeLineDimensions();

        // No college or major selected initially
        selectedCollege = null;
        selectedMajor = null;

        // Compute initial college data
        computeCollegeData();
        
        // Compute initial major data
        computeMajorData();
        
        // Compute initial amount data
        computeAmountData();
        
        // Initialize left pie chart
        initializeCollegeChart();
        
        // Initialize right pie chart
        initializeMajorChart();
        
        // Initialize line chart
        initializeAmountChart();
        
        // Load scene 1
        transitionScene1();
      }
    </script>
  </body>
  
</html>

